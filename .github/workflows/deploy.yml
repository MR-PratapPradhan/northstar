name: Deploy

on:
  push:
    branches: [dev, stage, prod]
    paths:
      - 'apps/**'
      - 'infra/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref_name }} # Automatically sets environment to dev/stage/prod
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::<ACCOUNT_ID>:role/<ROLE_NAME>
          aws-region: ap-south-1

      - name: Deploy with Terragrunt
        run: |
          terragrunt apply --terragrunt-working-dir infra/terragrunt/${{ github.ref_name }}

      - name: Publish deployment metadata
        run: |
          echo "Git SHA: ${{ github.sha }}"
          echo "SBOM hash: $(sha256sum sbom.json)"
          echo "Cosign bundle: $(cosign verify apps/retail-api:latest)"

